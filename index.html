<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <meta property="og:url"                content="https://geografa.github.io/pitchfinder/" />
  <meta property="og:type"               content="place" />
  <meta property="og:title"              content="‚öΩÔ∏è Find a pitch" />
  <meta property="og:description"        content="Get info on regular games around Portland" />
  <meta property="og:image"              content="https://geografa.github.io/pitchfinder/assets/pitchfinder.jpg" />
  <meta property="fb:app_id"             content="146253569362639" />

  <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <title>Find a soccer pitch</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.min.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.css' type='text/css' />
  <script src='./pitches.js'></script>

  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #info {
      display: block;
      position: absolute;
      margin: 0px auto;
      /* width: 20%; */
      padding: 10px;
      border: none;
      border-radius: 3px;
      font-size: 12px;
      text-align: left;
      color: #222;
      /*background: #fff; */
      left: 0;
      top: 10px;
    }
  </style>
</head>
<body>
<!-- Load Facebook SDK for JavaScript -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<!-- Your share button code -->
<div id='map'></div>
<div id='info'>
  <div class="fb-share-button" data-href="https://geografa.github.io/pitchfinder/" data-layout="button_count"></div>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZ3JhZmEiLCJhIjoiY2pjeG40N3cyMTZ6ajMzbzUwNHFleWRsMiJ9.n1yXQ4YMRi9ylrhaeah5dA';
var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/grafa/cj23ol2ed000u2rr25s4yv3s5',
  // style: 'mapbox://styles/mapbox/streets-v9',
  center: [-122.67773866653444,45.52245801087795],
  zoom: 11,
  hash: true
});

function forwardGeocoder(query) {
  var pitches = map.querySourceFeatures('portland-soccer-pitches', {
    sourceLayer: 'portland-soccer-pitches',
  });

  var matchingFeatures = []
  for (i=0; i<customData.features.length; i++){
    var feature = customData.features[i]
    query.toLowerCase();
    if (feature.properties.name.search(query) !== -1){
      feature['place_name']= '‚öΩÔ∏è ' + feature.properties.name
      feature['center'] = feature.geometry.coordinates
      // feature['place_type'] = ['park']
      matchingFeatures.push(feature);
    }
  }
  return matchingFeatures;
};

map.addControl(new MapboxGeocoder({
  accessToken: mapboxgl.accessToken,
  localGeocoder: forwardGeocoder,
  zoom: 17,
  bbox: [-124.0380626758699,45.2412126235823,-121.10311165853054,45.81306995608375],
  placeholder: "e.g Grant HS"
}));

var popup = new mapboxgl.Popup()

// When a click event occurs on a feature in the portland-soccer-pitches layer, open a popup at the
// location of the feature, with description HTML from its properties.
map.on('click', 'portland-soccer-pitches', function (e) {
  var coordinates = e.features[0].geometry.coordinates.slice();
  var name = e.features[0].properties.name;

  var search = decodeURIComponent(window.location.hash.split('#')[1]);
  var pitch = 'https://geografa.github.io/pitchfinder/#' + search;

  // Ensure that if the map is zoomed out such that multiple
  // copies of the feature are visible, the popup appears
  // over the copy being pointed to.
  while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
  }
  
  popup.setLngLat(coordinates)
    .setHTML('<strong>' + name + '</strong><br>üöó <a href="#" onclick="getLocation(getRoute)">Directions</a><br>'+
    'üìù <a href="mailto:soundofrafa@gmail.com?subject=Reporting%20Pitchfinder%20location&body=Please%20report%20a%20missing%20location,%20location%20edit,%20or%20type-o.%20Make%20sure%20the%20URL%20is%20in%20tact:%20'+ pitch + '">Suggest an edit</a>');
  popup.addTo(map);
});

const getLocation = (callback) => {
  navigator.geolocation.getCurrentPosition(function(position) {
    var start = position.coords.longitude + ',' + position.coords.latitude;
    callback(start);
  });
};

const getRoute = (start,dest) => {
  var dest = popup.getLngLat();
  var url = 'https://api.mapbox.com/directions/v5/mapbox/driving/' + start + ';' + dest.lng + ',' + dest.lat +
  '?geometries=geojson&overview=full&access_token=pk.eyJ1IjoiZ3JhZmEiLCJhIjoiY2oydGJoajI5MDA1bjJxbzZzZjd5MXl3NSJ9.vNVFm6NsFzeX0AGSjFHpqg';
  var req = new XMLHttpRequest();
  req.responseType = 'json';
  req.open('GET', url, true);
  req.onload  = function() {
     var jsonResponse = req.response;
     var route = jsonResponse.routes[0].geometry.coordinates;
     var geojson = {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "LineString",
            "coordinates": route
          }
        };
    if (map.getSource('route')) {
      map.getSource('route').setData(geojson);
    } else{
      map.addLayer({
        "id": "route",
        "type": "line",
        "source": {
          "type": "geojson",
          "data": {
            "type": "Feature",
            "properties": {},
            "geometry": {
              "type": "LineString",
              "coordinates": route
            }
          }

        },
        "layout": {
          "line-join": "round",
          "line-cap": "round"
        },
        "paint": {
          "line-color": "#007fff",
          "line-width": 5,
          "line-opacity": 0.75
        }
      },'portland-soccer-pitches');
    };
  };
  req.send();
};

// Change the cursor to a pointer when the mouse is over the portland-soccer-pitches layer.
map.on('mouseenter', 'portland-soccer-pitches', function () {
  map.getCanvas().style.cursor = 'pointer';
});

// Change it back to a pointer when it leaves.
map.on('mouseleave', 'portland-soccer-pitches', function () {
  map.getCanvas().style.cursor = '';
});

map.on('moveend', function () {
  var search = decodeURIComponent(window.location.hash.split('#')[1]);
  var pitch = 'https://geografa.github.io/pitchfinder/#' + search;
});

</script>

</body>
</html>
